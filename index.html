<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Generator Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border-color: transparent;
            border-top-color: #3b82f6; /* blue-500 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .subcategory-btn {
            @apply bg-white/70 backdrop-blur-sm hover:bg-white text-blue-800 font-semibold py-2 px-4 rounded-xl shadow-lg shadow-blue-500/10 transition-all duration-300 ease-in-out transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed border border-white/50 disabled:transform-none;
        }
        .subcategory-btn-active {
            @apply ring-2 ring-blue-500 ring-offset-2 ring-offset-blue-50;
        }
        .main-btn {
            display: inline-block;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(145deg, #4facfe, #00f2fe);
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .main-btn:hover:not(:disabled) {
            background: linear-gradient(145deg, #00f2fe, #4facfe);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .main-btn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.15);
        }

        .main-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800 flex items-center justify-center min-h-screen p-2 sm:p-4 md:p-8">

    <!-- Password Protection -->
    <div id="password-protection" class="fixed inset-0 bg-blue-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold text-blue-900 mb-4">Enter Password</h2>
            <p class="text-gray-600 mb-6">This is a private generator. Please enter the password to continue.</p>
            <input type="password" id="passwordInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Password">
            <button id="submitPasswordBtn" class="mt-4 w-full main-btn">Unlock</button>
            <p id="passwordError" class="text-red-500 mt-3 h-4"></p>
        </div>
    </div>

    <div id="main-content" class="w-full max-w-4xl text-center hidden">
        <header class="mb-8">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-blue-900">Creative Generator Studio</h1>
            <p id="subtitle" class="text-gray-600 mt-2">Your all-in-one tool for creative assets.</p>
        </header>

        <main>
            <!-- Action Buttons -->
            <div id="main-buttons-container" class="flex flex-wrap justify-center gap-4">
                 <button id="generateFrameByStyleBtn" class="main-btn">
                    Frame by Style
                </button>
                 <button id="generateFrameByShapeBtn" class="main-btn">
                    Frame by Shape
                </button>
                <button id="generatePlaqueByStyleBtn" class="main-btn">
                    Plaque by Style
                </button>
                 <button id="generatePlaqueByShapeBtn" class="main-btn">
                    Plaque by Shape
                </button>
                <button id="generateBackgroundBtn" class="main-btn">
                    Generate Background
                </button>
                 <button id="generateTextBtn" class="main-btn">
                    Generate Text
                </button>
                 <button id="generateTarotCardBtn" class="main-btn">
                    Generate Tarot Card
                </button>
                <button id="generateDeckBtn" class="main-btn">
                    Generate Card Deck
                </button>
                 <button id="generatePhotographicFrameBtn" class="main-btn">
                    Photographic Frame
                </button>
                 <button id="resizeImageBtn" class="main-btn">
                    Image Resizer
                </button>
                 <button id="generateStoryBtn" class="main-btn">
                    Book Creator
                </button>
            </div>
            
            <!-- Story Generator -->
            <div id="story-generator-container" class="hidden w-full space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                    <div>
                        <label class="font-semibold text-gray-700">Book Title:</label>
                        <input type="text" id="storyTitleInput" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., The Adventures of Oliver">
                    </div>
                    <div>
                        <label class="font-semibold text-gray-700">Author Name:</label>
                        <input type="text" id="authorNameInput" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., Jane Doe">
                    </div>
                     <div>
                        <label class="font-semibold text-gray-700">Story Theme / Plot:</label>
                        <input type="text" id="storyThemeInput" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., A brave little cat who lost its mom">
                    </div>
                     <div>
                        <label class="font-semibold text-gray-700">Art Style:</label>
                        <input type="text" id="artStyleInput" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., Cute children's book watercolor">
                    </div>
                     <div class="md:col-span-2">
                        <label class="font-semibold text-gray-700">Main Character Description:</label>
                        <input type="text" id="characterDescInput" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., A small ginger kitten with a floppy ear named Oliver">
                    </div>
                </div>

                <div class="pt-4 space-y-4">
                    <h3 class="text-xl font-semibold text-blue-800">Generate Story Automatically</h3>
                     <div class="flex flex-wrap justify-center gap-3">
                         <button id="gen1PageBtn" class="subcategory-btn">Generate 1 Page</button>
                         <button id="gen10PageBtn" class="subcategory-btn">Generate 10 Pages</button>
                         <button id="gen25PageBtn" class="subcategory-btn">Generate 25 Pages</button>
                         <button id="gen50PageBtn" class="subcategory-btn">Generate 50 Pages</button>
                         <button id="gen100PageBtn" class="subcategory-btn">Generate 100 Pages</button>
                     </div>
                </div>
                
                 <div class="pt-4 space-y-4">
                    <h3 class="text-xl font-semibold text-blue-800">Add Custom Page</h3>
                    <div>
                        <label class="font-semibold text-gray-700">Page Text:</label>
                        <textarea id="customPageTextInput" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" rows="4" placeholder="Write your own story text here..."></textarea>
                    </div>
                     <div>
                        <label class="font-semibold text-gray-700">Image Prompt for this page:</label>
                        <input type="text" id="customPageImagePrompt" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., Oliver peeking out from behind a hay bale">
                    </div>
                    <button id="addCustomPageBtn" class="main-btn">Add Custom Page</button>
                </div>
                
                <div class="pt-4 space-y-4">
                    <h3 class="text-xl font-semibold text-blue-800">Download Your Book</h3>
                     <div>
                        <label class="font-semibold text-gray-700">Author Blurb (for back cover):</label>
                        <textarea id="authorBlurbInput" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" rows="3" placeholder="Write a short author bio here..."></textarea>
                    </div>
                    <div>
                        <label class="font-semibold text-gray-700 mb-2 block">Choose Book Size:</label>
                        <select id="bookSizeSelect" class="w-full max-w-md p-2 border border-gray-300 rounded-lg shadow-sm">
                            <option value="paperback">Standard Paperback (6x9 in)</option>
                            <option value="kindle">Kindle (6x9 in ratio)</option>
                            <option value="hardcover">Hardcover (6.14x9.21 in)</option>
                            <option value="picturebook">Square Picture Book (8.5x8.5 in)</option>
                            <option value="google">Google Books (A4)</option>
                        </select>
                    </div>
                    <button id="downloadPdfBtn" class="main-btn hidden">Download Book as PDF</button>
                </div>

                <button class="back-btn mt-6 text-gray-500 hover:text-gray-800 transition-colors">← Back</button>
            </div>

            <!-- Frame Subcategories -->
            <div id="frame-subcategories-container" class="hidden">
                <p class="text-gray-500 mb-4">Choose a Frame Style:</p>
                <div class="flex flex-wrap justify-center gap-3">
                    <button class="subcategory-btn" data-type="frame" data-subcategory="Vintage">Vintage</button>
                    <button class="subcategory-btn" data-type="frame" data-subcategory="Modern">Modern</button>
                    <button class="subcategory-btn" data-type="frame" data-subcategory="Fantasy">Fantasy</button>
                    <button class="subcategory-btn" data-type="frame" data-subcategory="Wedding">Wedding</button>
                    <button class="subcategory-btn" data-type="frame" data-subcategory="Natural">Natural</button>
                    <button class="subcategory-btn" data-type="frame" data-subcategory="Rose Arch">Rose Arch</button>
                    <button class="subcategory-btn" data-type="frame" data-subcategory="Jeweled">Jeweled</button>
                    <button class="subcategory-btn" data-type="frame" data-subcategory="Peacock">Peacock</button>
                </div>
                <button class="back-btn mt-6 text-gray-500 hover:text-gray-800 transition-colors">← Back</button>
            </div>

            <!-- Frame Shape Subcategories -->
            <div id="frame-shape-subcategories-container" class="hidden">
                <p class="text-gray-500 mb-4">Choose a Frame Shape:</p>
                <div class="flex flex-wrap justify-center gap-3">
                     <button class="subcategory-btn" data-shape="Rectangular">Rectangular</button>
                     <button class="subcategory-btn" data-shape="Square">Square</button>
                     <button class="subcategory-btn" data-shape="Circular">Circular</button>
                     <button class="subcategory-btn" data-shape="Oval">Oval</button>
                     <button class="subcategory-btn" data-shape="Arch">Arch</button>
                </div>
                <button class="back-btn mt-6 text-gray-500 hover:text-gray-800 transition-colors">← Back</button>
            </div>

            <!-- Plaque Style Subcategories -->
            <div id="plaque-style-subcategories-container" class="hidden">
                <p class="text-gray-500 mb-4">Choose a Plaque Style:</p>
                <div class="flex flex-wrap justify-center gap-3">
                    <button class="subcategory-btn" data-type="plaque" data-subcategory="Wedding">Wedding</button>
                    <button class="subcategory-btn" data-type="plaque" data-subcategory="Rustic">Rustic</button>
                    <button class="subcategory-btn" data-type="plaque" data-subcategory="Modern">Modern</button>
                    <button class="subcategory-btn" data-type="plaque" data-subcategory="Botanical/Floral">Botanical/Floral</button>
                    <button class="subcategory-btn" data-type="plaque" data-subcategory="Carved Wood">Carved Wood</button>
                    <button class="subcategory-btn" data-type="plaque" data-subcategory="Vintage">Vintage</button>
                    <button class="subcategory-btn" data-type="plaque" data-subcategory="Metallic">Metallic</button>
                    <button class="subcategory-btn" data-type="plaque" data-subcategory="Jeweled">Jeweled</button>
                    <button class="subcategory-btn" data-type="plaque" data-subcategory="Peacock">Peacock</button>
                    <button class="subcategory-btn" data-type="plaque" data-subcategory="Exclusive Mix">Exclusive Mix</button>
                    <button class="subcategory-btn" data-type="plaque" data-subcategory="Exclusive Rectangle">Exclusive Rectangle</button>
                    <button class="subcategory-btn" data-type="plaque" data-subcategory="Thin Border Horizontal">Thin Border Horizontal</button>
                    <button class="subcategory-btn" data-type="plaque" data-subcategory="Surprise">Surprise Me!</button>
                </div>
                <button class="back-btn mt-6 text-gray-500 hover:text-gray-800 transition-colors">← Back</button>
            </div>

            <!-- Plaque Shape Subcategories -->
            <div id="plaque-shape-subcategories-container" class="hidden">
                <p class="text-gray-500 mb-4">Choose a Plaque Shape:</p>
                <div class="flex flex-wrap justify-center gap-3">
                     <button class="subcategory-btn" data-shape="Rectangular">Rectangular</button>
                     <button class="subcategory-btn" data-shape="Square">Square</button>
                     <button class="subcategory-btn" data-shape="Circular">Circular</button>
                     <button class="subcategory-btn" data-shape="Oval">Oval</button>
                     <button class="subcategory-btn" data-shape="Heart">Heart</button>
                     <button class="subcategory-btn" data-shape="Hexagon">Hexagon</button>
                </div>
                <button class="back-btn mt-6 text-gray-500 hover:text-gray-800 transition-colors">← Back</button>
            </div>

            <!-- Background Generator -->
            <div id="background-generator-container" class="hidden">
                <div id="background-size-selector">
                    <p class="text-gray-500 mb-4">First, choose an image size or type:</p>
                    <div class="flex flex-wrap justify-center gap-3">
                        <button class="subcategory-btn" data-size="9:16">Portrait (9:16)</button>
                        <button class="subcategory-btn" data-size="16:9">Landscape (16:9)</button>
                        <button class="subcategory-btn" data-size="1:1">Square (1:1)</button>
                        <button class="subcategory-btn" data-size="transparent">Transparent Object</button>
                        <button class="subcategory-btn" data-size="tarot">Tarot Card</button>
                    </div>
                </div>
                <div id="background-prompt-container" class="hidden">
                     <p class="text-gray-500 mb-4">Describe the background you want:</p>
                     <input type="text" id="backgroundInput" class="w-full max-w-md p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., beautiful sunset over mountains">
                     <button id="submitBackgroundBtn" class="mt-4 main-btn">Generate Background</button>
                </div>
                <button class="back-btn mt-6 text-gray-500 hover:text-gray-800 transition-colors">← Back</button>
            </div>
            
             <!-- Text Generator -->
            <div id="text-generator-container" class="hidden w-full space-y-4">
                <div>
                    <p class="text-gray-500 mb-2">1. Enter your text:</p>
                    <input type="text" id="textInput" class="w-full max-w-md p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Happy Birthday">
                </div>
                <div>
                    <p class="text-gray-500 mb-2">2. Choose a style:</p>
                    <div id="text-style-buttons" class="flex flex-wrap justify-center gap-3">
                        <button class="subcategory-btn" data-style="Gold">3D Gold</button>
                        <button class="subcategory-btn" data-style="Silver">3D Silver</button>
                        <button class="subcategory-btn" data-style="Neon">Neon Glow</button>
                        <button class="subcategory-btn" data-style="Sticker">Sticker</button>
                        <button class="subcategory-btn" data-style="Fire">Fire</button>
                        <button class="subcategory-btn" data-style="Ice">Ice</button>
                        <button class="subcategory-btn" data-style="Wood">Wood Carved</button>
                        <button class="subcategory-btn" data-style="Cursive">Cursive</button>
                        <button class="subcategory-btn" data-style="Serif">Serif</button>
                        <button class="subcategory-btn" data-style="Bold">Bold</button>
                        <button class="subcategory-btn" data-style="Brush">Brush Script</button>
                        <button class="subcategory-btn" data-style="Calligraphy">Calligraphy</button>
                    </div>
                </div>
                 <div>
                    <p class="text-gray-500 mb-2">3. Generate your image:</p>
                    <div class="flex flex-wrap justify-center gap-3">
                         <button id="submitTextTransparentBtn" class="main-btn" disabled>Generate (Transparent)</button>
                         <button id="submitTextWithBgBtn" class="main-btn" disabled>Generate (With BG)</button>
                    </div>
                </div>
                <button class="back-btn mt-6 text-gray-500 hover:text-gray-800 transition-colors">← Back</button>
            </div>

            <!-- Tarot Card Generator -->
            <div id="tarot-generator-container" class="hidden w-full space-y-4">
                <div id="tarot-size-selector">
                    <p class="text-gray-500 mb-4">First, choose a card size:</p>
                    <div class="flex flex-wrap justify-center gap-3">
                        <button class="subcategory-btn" data-size="Standard Tarot">Standard Tarot</button>
                        <button class="subcategory-btn" data-size="Large Tarot">Large Tarot</button>
                        <button class="subcategory-btn" data-size="Mini Tarot">Mini Tarot</button>
                        <button class="subcategory-btn" data-size="Oracle Card">Oracle Card</button>
                    </div>
                </div>
                <div id="tarot-prompt-container" class="hidden space-y-4">
                    <div>
                         <p class="text-gray-500 mb-2">Now, choose a theme or describe your card:</p>
                         <div id="tarot-theme-buttons" class="flex flex-wrap justify-center gap-3 mb-4">
                            <button class="subcategory-btn" data-theme="angel chibi card">Angel Chibi</button>
                            <button class="subcategory-btn" data-theme="ethereal angelic fantasy">Angelic Fantasy</button>
                            <button class="subcategory-btn" data-theme="dark gothic fantasy">Gothic Fantasy</button>
                            <button class="subcategory-btn" data-theme="cosmic nebula celestial">Cosmic</button>
                         </div>
                         <input type="text" id="tarotInput" class="w-full max-w-md p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="or type your own theme, e.g., the sun goddess">
                    </div>
                    <div>
                        <p class="text-gray-500 mb-2">Add text to the card (optional):</p>
                        <input type="text" id="tarotTextInput" class="w-full max-w-md p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., The Magician">
                    </div>
                     <div>
                        <p class="text-gray-500 mb-2">Generate your card:</p>
                         <div class="flex flex-wrap justify-center gap-3">
                             <button id="submitTarotTransparentBtn" class="main-btn">Generate (Transparent)</button>
                             <button id="submitTarotWithBgBtn" class="main-btn">Generate (With BG)</button>
                         </div>
                    </div>
                </div>
                <button class="back-btn mt-6 text-gray-500 hover:text-gray-800 transition-colors">← Back</button>
            </div>

             <!-- Deck Generator -->
            <div id="deck-generator-container" class="hidden w-full space-y-4">
                 <div>
                    <p class="text-gray-500 mb-2">1. Define a consistent theme for your entire deck:</p>
                    <input type="text" id="deckThemeInput" class="w-full max-w-md p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Art Nouveau Cats, Cosmic Horror">
                </div>
                 <div>
                    <p class="text-gray-500 mb-2">2. Enter the name of the card to generate:</p>
                    <input type="text" id="cardNameInput" class="w-full max-w-md p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., The Fool, Ace of Swords, Serenity">
                </div>
                 <div>
                    <p class="text-gray-500 mb-2">3. Add text to the card (optional):</p>
                    <input type="text" id="deckCardTextInput" class="w-full max-w-md p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., The Fool">
                </div>
                <button id="submitDeckCardBtn" class="main-btn">Generate Card for Deck</button>
                <button class="back-btn mt-6 text-gray-500 hover:text-gray-800 transition-colors">← Back</button>
            </div>
            
            <!-- Photographic Frame Generator -->
            <div id="photographic-frame-container" class="hidden w-full space-y-4">
                <div id="photo-size-selector">
                    <p class="text-gray-500 mb-4">1. Choose the final orientation:</p>
                    <div class="flex flex-wrap justify-center gap-3">
                        <button class="subcategory-btn" data-photosize="9:16">Portrait (9:16)</button>
                        <button class="subcategory-btn" data-photosize="16:9">Landscape (16:9)</button>
                        <button class="subcategory-btn" data-photosize="1:1">Square (1:1)</button>
                        <button class="subcategory-btn" data-photosize="original">Use Original Photo Size</button>
                    </div>
                </div>
                <div id="photo-details-container" class="hidden w-full space-y-4">
                     <div>
                         <p class="text-gray-500 mb-2">2. Upload your photo:</p>
                         <label for="photoUploadInput" class="subcategory-btn cursor-pointer inline-block">
                             Choose File
                         </label>
                         <input type="file" id="photoUploadInput" class="hidden" accept="image/*">
                         <img id="photoPreview" class="hidden mt-4 mx-auto max-h-48 rounded-lg shadow-md">
                     </div>
                     <div>
                        <p class="text-gray-500 mb-2">3. Describe the frame theme:</p>
                        <input type="text" id="frameThemeInput" class="w-full max-w-md p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Kids birthday unicorn theme, vintage gold">
                    </div>
                     <div>
                        <p class="text-gray-500 mb-2">4. Add text overlay (optional):</p>
                        <input type="text" id="frameTextInput" class="w-full max-w-md p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Happy 5th Birthday, Chloe!">
                    </div>
                    <button id="submitPhotographicFrameBtn" class="main-btn" disabled>Generate Photographic Frame</button>
                </div>
                <button class="back-btn mt-6 text-gray-500 hover:text-gray-800 transition-colors">← Back</button>
            </div>

            <!-- Image Resizer -->
            <div id="image-resizer-container" class="hidden w-full space-y-4">
                <div>
                    <p class="text-gray-500 mb-2">1. Upload the image you want to resize:</p>
                    <label for="resizeUploadInput" class="subcategory-btn cursor-pointer inline-block">
                        Choose File
                    </label>
                    <input type="file" id="resizeUploadInput" class="hidden" accept="image/*">
                </div>
                <div id="resize-options-container" class="hidden">
                    <p class="text-gray-500 mb-2">2. Choose a new size to crop to:</p>
                    <div class="flex flex-wrap justify-center gap-3">
                        <button class="subcategory-btn" data-resize="9:16">Crop to 9:16</button>
                        <button class="subcategory-btn" data-resize="16:9">Crop to 16:9</button>
                        <button class="subcategory-btn" data-resize="1:1">Crop to 1:1</button>
                        <button class="subcategory-btn" data-resize="4:5">Crop to 4:5</button>
                        <button class="subcategory-btn" data-resize="3:2">Crop to 3:2</button>
                        <button class="subcategory-btn" data-resize="2:3">Crop to 2:3</button>
                    </div>
                </div>
                 <button class="back-btn mt-6 text-gray-500 hover:text-gray-800 transition-colors">← Back</button>
            </div>


            <!-- Display Area -->
            <div id="displayArea" class="mt-8 w-full max-w-lg lg:max-w-3xl mx-auto aspect-square bg-white border border-gray-200 rounded-xl shadow-inner flex items-center justify-center overflow-hidden transition-all duration-500 ease-in-out">
                <div id="loader" class="hidden spinner w-16 h-16 border-4 rounded-full" role="status"><span class="sr-only">Loading...</span></div>
                <div id="story-display-container" class="hidden flex flex-col items-center justify-center p-4 h-full">
                    <img id="storyImageDisplay" src="" alt="Generated Story Image" class="max-w-full h-auto max-h-[70%] object-contain"/>
                    <p id="storyTextDisplay" class="text-gray-700 mt-4 text-center text-sm sm:text-base"></p>
                </div>
                 <img id="frameImage" src="" alt="Generated Item" class="hidden max-w-full max-h-full object-contain"/>
                <canvas id="resizeCanvas" class="hidden"></canvas>
                <p id="initialText" class="text-gray-500">Your generated image will appear here</p>
            </div>
            <div id="errorMessage" class="mt-4 text-red-600 font-medium h-6"></div>
            <div class="flex justify-center items-center gap-4 mt-6">
                <a id="downloadBtn" href="#" download="generated-item.png" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105 inline-block">Download</a>
                <button id="regenerateBtn" class="hidden bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105">Regenerate</button>
                <button id="resetBtn" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105">Reset</button>
            </div>

            <!-- Deck Gallery -->
            <div id="deck-gallery-container" class="hidden w-full mt-6">
                <h3 class="text-xl font-semibold mb-3 text-blue-900">Your Deck So Far</h3>
                <div id="deck-gallery" class="flex flex-wrap gap-3 justify-center bg-white/50 p-3 rounded-xl">
                    <!-- Thumbnails will be added here -->
                </div>
            </div>
            
             <!-- Story Gallery -->
            <div id="story-gallery-container" class="hidden w-full mt-6">
                <h3 class="text-xl font-semibold mb-3 text-blue-900">Your Story So Far</h3>
                <div id="story-gallery" class="flex flex-wrap gap-3 justify-center bg-white/50 p-3 rounded-xl">
                    <!-- Story page thumbnails will be added here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- UI Elements ---
        const generateFrameByStyleBtn = document.getElementById('generateFrameByStyleBtn');
        const generateFrameByShapeBtn = document.getElementById('generateFrameByShapeBtn');
        const generatePlaqueByStyleBtn = document.getElementById('generatePlaqueByStyleBtn');
        const generatePlaqueByShapeBtn = document.getElementById('generatePlaqueByShapeBtn');
        const generateBackgroundBtn = document.getElementById('generateBackgroundBtn');
        const generateTextBtn = document.getElementById('generateTextBtn');
        const generateTarotCardBtn = document.getElementById('generateTarotCardBtn');
        const generateDeckBtn = document.getElementById('generateDeckBtn');
        const generatePhotographicFrameBtn = document.getElementById('generatePhotographicFrameBtn');
        const resizeImageBtn = document.getElementById('resizeImageBtn');
        const generateStoryBtn = document.getElementById('generateStoryBtn');

        const mainButtonsContainer = document.getElementById('main-buttons-container');
        const frameSubcategoriesContainer = document.getElementById('frame-subcategories-container');
        const plaqueStyleSubcategoriesContainer = document.getElementById('plaque-style-subcategories-container');
        const plaqueShapeSubcategoriesContainer = document.getElementById('plaque-shape-subcategories-container');
        const frameShapeSubcategoriesContainer = document.getElementById('frame-shape-subcategories-container');
        const backgroundGeneratorContainer = document.getElementById('background-generator-container');
        const textGeneratorContainer = document.getElementById('text-generator-container');
        const tarotGeneratorContainer = document.getElementById('tarot-generator-container');
        const deckGeneratorContainer = document.getElementById('deck-generator-container');
        const photographicFrameContainer = document.getElementById('photographic-frame-container');
        const imageResizerContainer = document.getElementById('image-resizer-container');
        const storyGeneratorContainer = document.getElementById('story-generator-container');
        
        const passwordProtection = document.getElementById('password-protection');
        const mainContent = document.getElementById('main-content');
        const passwordInput = document.getElementById('passwordInput');
        const submitPasswordBtn = document.getElementById('submitPasswordBtn');
        const passwordError = document.getElementById('passwordError');

        const backgroundSizeSelector = document.getElementById('background-size-selector');
        const backgroundPromptContainer = document.getElementById('background-prompt-container');
        const backgroundInput = document.getElementById('backgroundInput');
        const submitBackgroundBtn = document.getElementById('submitBackgroundBtn');
        
        const textInput = document.getElementById('textInput');
        const textStyleButtonsContainer = document.getElementById('text-style-buttons');
        const submitTextTransparentBtn = document.getElementById('submitTextTransparentBtn');
        const submitTextWithBgBtn = document.getElementById('submitTextWithBgBtn');
        
        const tarotSizeSelector = document.getElementById('tarot-size-selector');
        const tarotPromptContainer = document.getElementById('tarot-prompt-container');
        const tarotThemeButtons = document.getElementById('tarot-theme-buttons');
        const tarotInput = document.getElementById('tarotInput');
        const tarotTextInput = document.getElementById('tarotTextInput');
        const submitTarotTransparentBtn = document.getElementById('submitTarotTransparentBtn');
        const submitTarotWithBgBtn = document.getElementById('submitTarotWithBgBtn');
        
        const deckThemeInput = document.getElementById('deckThemeInput');
        const cardNameInput = document.getElementById('cardNameInput');
        const deckCardTextInput = document.getElementById('deckCardTextInput');
        const submitDeckCardBtn = document.getElementById('submitDeckCardBtn');
        const deckGalleryContainer = document.getElementById('deck-gallery-container');
        const deckGallery = document.getElementById('deck-gallery');
        
        const photoSizeSelector = document.getElementById('photo-size-selector');
        const photoDetailsContainer = document.getElementById('photo-details-container');
        const photoUploadInput = document.getElementById('photoUploadInput');
        const photoPreview = document.getElementById('photoPreview');
        const frameThemeInput = document.getElementById('frameThemeInput');
        const frameTextInput = document.getElementById('frameTextInput');
        const submitPhotographicFrameBtn = document.getElementById('submitPhotographicFrameBtn');
        
        const resizeUploadInput = document.getElementById('resizeUploadInput');
        const resizeOptionsContainer = document.getElementById('resize-options-container');
        const resizeCanvas = document.getElementById('resizeCanvas');
        
        const storyTitleInput = document.getElementById('storyTitleInput');
        const authorNameInput = document.getElementById('authorNameInput');
        const storyThemeInput = document.getElementById('storyThemeInput');
        const artStyleInput = document.getElementById('artStyleInput');
        const characterDescInput = document.getElementById('characterDescInput');
        const pagePromptInput = document.getElementById('pagePromptInput');
        const submitStoryPageBtn = document.getElementById('submitStoryPageBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const storyDisplayContainer = document.getElementById('story-display-container');
        const storyImageDisplay = document.getElementById('storyImageDisplay');
        const storyTextDisplay = document.getElementById('storyTextDisplay');
        const storyGalleryContainer = document.getElementById('story-gallery-container');
        const storyGallery = document.getElementById('story-gallery');
        const customPageTextInput = document.getElementById('customPageTextInput');
        const customPageImagePrompt = document.getElementById('customPageImagePrompt');
        const addCustomPageBtn = document.getElementById('addCustomPageBtn');
        const authorBlurbInput = document.getElementById('authorBlurbInput');
        const bookSizeSelect = document.getElementById('bookSizeSelect');
        const gen1PageBtn = document.getElementById('gen1PageBtn');
        const gen10PageBtn = document.getElementById('gen10PageBtn');
        const gen25PageBtn = document.getElementById('gen25PageBtn');
        const gen50PageBtn = document.getElementById('gen50PageBtn');
        const gen100PageBtn = document.getElementById('gen100PageBtn');


        const subtitle = document.getElementById('subtitle');
        const downloadBtn = document.getElementById('downloadBtn');
        const regenerateBtn = document.getElementById('regenerateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const loader = document.getElementById('loader');
        const frameImage = document.getElementById('frameImage');
        const initialText = document.getElementById('initialText');
        const errorMessage = document.getElementById('errorMessage');

        // --- State ---
        let lastGenerationConfig = null;
        let currentFlow = 'main';
        let chosenShape = null;
        let chosenBGSize = null;
        let chosenTextStyle = null;
        let chosenTarotSize = null;
        let uploadedPhotoData = null;
        let chosenPhotoFrameSize = null;
        let imageToResize = null;
        let storyPages = [];


        // --- Data Structures for Prompts ---
        const frameOptions = {
            "Vintage": { styles: ["ornate vintage gold", "baroque rococo style", "art deco geometric", "art nouveau elegant"], shapes: ["rectangular", "oval", "ornate plaque shape"], details: ["with intricate carvings", "with lavish filigree", "with gold inlays", "with flowing curved lines"] },
            "Modern": { styles: ["minimalist sleek wooden", "sci-fi futuristic metal", "cyberpunk neon holographic"], shapes: ["rectangular", "square", "circular"], details: ["with a smooth finish", "with clean, polished surfaces", "with glowing light effects"] },
            "Fantasy": { styles: ["gothic dark fantasy", "steampunk gears and pipes"], shapes: ["arch", "ornate plaque shape", "circular"], details: ["with dark metal details", "with copper and brass elements", "encrusted with jewels"] },
            "Wedding": { styles: ["elegant golden wedding arch", "royal velvet and gold", "elegant wedding lace"], shapes: ["arch", "heart shaped", "oval"], details: ["decorated with beautiful red roses", "adorned with white pearls and ribbons", "encrusted with diamonds"] },
            "Natural": { styles: ["floral botanical", "tribal ethnic pattern", "rustic wooden"], shapes: ["rectangular", "circular", "square"], details: ["with intertwined vines and flowers", "with bold geometric patterns", "with a natural wood grain"] },
            "Rose Arch": { styles: ["elegant golden wedding arch", "gleaming gold arch structure"], shapes: ["arch", "tall archway"], details: ["decorated with beautiful realistic red roses", "covered in lush red rose arrangements", "with a candelabra accent"] },
            "Jeweled": { styles: ["gemstone encrusted gold", "diamond bordered platinum", "sapphire and ruby mosaic"], shapes: ["rectangular", "oval", "ornate plaque shape"], details: ["with sparkling precious stones", "with intricate inlaid gems", "with a polished, high-gloss finish"] },
            "Peacock": { styles: ["art nouveau peacock feather", "gilded peacock motif", "majestic peacock design"], shapes: ["arch", "oval", "fan-shaped"], details: ["with iridescent blues and greens", "with elegant peacock feather details", "adorned with small jewels resembling peacock eyes"] }
        };

        const plaqueOptions = {
            "Wedding": { styles: ["luxurious floral wedding sign", "premium white and 24k gold welcome board", "designer clear acrylic calligraphy sign"], shapes: ["vertical rectangular", "square", "hexagon", "arch", "heart shaped"], details: ["adorned with premium silk ribbons and pearls", "with shimmering rose gold foil accents", "decorated with lush eucalyptus and lavender arrangements", "in a sophisticated pastel wedding palette", "flawless 3D effect with soft, realistic shadows"] },
            "Rustic": { styles: ["carved dark wood plaque", "rustic wood sign", "slate rock plaque", "nautical themed driftwood plaque", "cast iron vintage sign"], shapes: ["wide rectangular", "square", "arrow shaped sign", "ornate plaque shape"], details: ["with a rustic dark wood grain finish", "with a chiseled, rough-hewn texture", "with weathered engraved details", "with embossed metal", "with a 3D relief effect"] },
            "Modern": { styles: ["modern polished acrylic glass plaque", "frosted glass plaque", "futuristic metallic sign"], shapes: ["rectangular", "circular", "square", "hexagon"], details: ["crystal clear with beveled edges", "with polished gold standoffs for mounting", "with holographic glowing elements", "clean 3D render"] },
            "Botanical/Floral": { styles: ["etched botanical glass sign", "rustic sign with painted flowers and leaves", "transparent sign with a floral and leaf arrangement"], shapes: ["circular", "rectangular", "square", "oval"], details: ["painted with delicate watercolor wildflowers and ferns", "with intricate laser-etched botanical patterns", "framed by blooming flowers and lush greenery", "with 3D floral and foliage elements"] },
            "Carved Wood": { styles: ["ornate carved dark wood plaque", "vintage wooden sign board", "antique mahogany plaque"], shapes: ["ornate plaque shape", "wide rectangular", "square"], details: ["with intricate rococo carvings", "with a deep rich wood grain finish", "with detailed filigree on the edges", "3D render with deep shadows"] },
            "Vintage": { styles: ["museum-quality antique cast iron sign", "art nouveau brass plaque", "hand-carved victorian-era wooden board", "faded painted tin sign", "baroque gold gilded plaque"], shapes: ["ornate plaque shape", "oval", "rectangular with decorative corners", "square"], details: ["with weathered and aged texture", "with embossed lettering", "with elegant filigree borders", "3D, photorealistic with patina"] },
            "Metallic": { styles: ["premium 24k gold plated plaque", "designer brushed steel sign", "gleaming chrome nameplate with intricate etching", "antique bronze tablet with high relief", "lustrous rose gold metallic sign"], shapes: ["rectangular", "circular", "square", "hexagon"], details: ["with precision-engraved text", "with a flawless mirror-like surface", "with sharp, polished beveled edges", "with sophisticated 3D embossed logos", "ultra-realistic 3D render"] },
            "Jeweled": { styles: ["premium gemstone inlaid marble plaque", "diamond bordered acrylic award", "sapphire and ruby mosaic sign"], shapes: ["rectangular", "circular", "shield-shaped"], details: ["with sparkling inset diamonds and sapphires", "with intricate faceted gems", "with a polished, high-gloss finish"] },
            "Peacock": { styles: ["art nouveau peacock feather engraved plaque", "gilded peacock motif on a wooden board", "majestic peacock design sign"], shapes: ["oval", "fan-shaped", "rectangular"], details: ["with iridescent enamel inlay", "with elegant peacock feather engravings", "adorned with small jewels in peacock colors"] },
            "Exclusive Mix": { styles: ["luxurious floral wedding sign with metallic accents", "premium 24k gold and diamond bordered acrylic", "designer peacock feather motif on carved wood"], shapes: ["rectangular", "ornate plaque shape", "square"], details: ["adorned with premium silk ribbons and sparkling gems", "with shimmering rose gold foil and intricate engravings", "flawless 3D effect with a mix of high-gloss and matte finishes"] },
            "Exclusive Rectangle": { styles: ["ornate vintage gold and cyberpunk neon holographic", "art nouveau peacock feather with gemstone encrusting", "baroque rococo and diamond bordered platinum"], shapes: ["rectangular"], details: ["with intricate carvings and glowing light effects", "adorned with iridescent peacock feathers and sparkling precious stones", "with lavish filigree and inlaid gems"] },
            "Thin Border Horizontal": { styles: ["minimalist modern plaque with a thin border", "elegant thin gold border sign with light carvings", "sleek silver frame plaque with delicate carvings", "thin wooden plaque with light carvings"], shapes: ["wide rectangular"], details: ["with a very thin, delicate border and a large central space", "with intricate, subtle carvings along the thin border", "designed for maximum text visibility", "with a clean, minimalist aesthetic but with ornate carved corners"] },
            "Surprise": { styles: ["whimsical cartoon style", "colorful abstract art", "pop-art comic book style", "surreal dreamscape"], shapes: ["rectangular", "square", "circular", "oval", "heart", "hexagon", "star shaped"], details: ["with vibrant rainbow colors", "with bold, graphic patterns", "with unexpected textures", "with a playful, fun feel", "3D, bright and cheerful"] }
        };
        
        const textOptions = {
            "Gold": "in a bold 3D gold style, beveled edges, photorealistic reflections and highlights, metallic texture, word art, typography",
            "Silver": "in a bold 3D polished silver style, chrome effect, metallic sheen, clean reflections, word art, typography",
            "Neon": "in a glowing neon sign style, vibrant electric colors, realistic bloom effect on a dark background, word art, typography",
            "Sticker": "as a die-cut sticker, bold outlines, glossy finish, vibrant cartoon colors, graphic design, word art, typography",
            "Fire": "made of realistic flames, fiery texture, glowing embers, word art, typography",
            "Ice": "made of cracked blue ice, frozen texture, frosty details, word art, typography",
            "Wood": "carved from rich dark wood, realistic wood grain texture, 3D engraved effect, word art, typography",
            "Cursive": "in an elegant, flowing cursive script, typography, word art",
            "Serif": "in a classic, bold serif font, like Times New Roman, typography, word art",
            "Bold": "in a heavy, sans-serif bold font, clean and modern, typography, word art",
            "Brush": "in an artistic brush script style, textured paint strokes, typography, word art",
            "Calligraphy": "in a beautiful calligraphy style with ornate flourishes, ink on paper effect, typography, word art"
        };


        // --- UI Navigation ---
        function showSubcategories(type) {
            mainButtonsContainer.classList.add('hidden');
            frameSubcategoriesContainer.classList.add('hidden');
            plaqueStyleSubcategoriesContainer.classList.add('hidden');
            plaqueShapeSubcategoriesContainer.classList.add('hidden');
            frameShapeSubcategoriesContainer.classList.add('hidden');
            backgroundGeneratorContainer.classList.add('hidden');
            textGeneratorContainer.classList.add('hidden');
            tarotGeneratorContainer.classList.add('hidden');
            deckGeneratorContainer.classList.add('hidden');
            photographicFrameContainer.classList.add('hidden');
            imageResizerContainer.classList.add('hidden');
            storyGeneratorContainer.classList.add('hidden');


            if (type === 'frame-style') {
                frameSubcategoriesContainer.classList.remove('hidden');
                subtitle.textContent = (currentFlow === 'shapeFirst' && chosenShape) 
                    ? `Now, choose a style for your ${chosenShape.toLowerCase()} frame:` 
                    : "Choose a style for your frame.";
            } else if (type === 'frame-shape') {
                frameShapeSubcategoriesContainer.classList.remove('hidden');
                subtitle.textContent = "First, choose a shape for your frame.";
            } else if (type === 'plaque-style') {
                plaqueStyleSubcategoriesContainer.classList.remove('hidden');
                subtitle.textContent = (currentFlow === 'shapeFirst' && chosenShape) 
                    ? `Now, choose a style for your ${chosenShape.toLowerCase()} plaque:` 
                    : "Choose a style for your plaque.";
            } else if (type === 'plaque-shape') {
                plaqueShapeSubcategoriesContainer.classList.remove('hidden');
                subtitle.textContent = "First, choose a shape for your plaque.";
            } else if (type === 'background') {
                backgroundGeneratorContainer.classList.remove('hidden');
                backgroundSizeSelector.classList.remove('hidden');
                backgroundPromptContainer.classList.add('hidden');
                subtitle.textContent = "First, choose a size or type for your background.";
            } else if (type === 'text') {
                textGeneratorContainer.classList.remove('hidden');
                subtitle.textContent = "Create custom text art.";
            } else if (type === 'tarot') {
                tarotGeneratorContainer.classList.remove('hidden');
                tarotSizeSelector.classList.remove('hidden');
                tarotPromptContainer.classList.add('hidden');
                subtitle.textContent = "First, choose a card size.";
            } else if (type === 'deck') {
                deckGeneratorContainer.classList.remove('hidden');
                subtitle.textContent = "Generate a consistent card deck.";
            } else if (type === 'photographic-frame') {
                photographicFrameContainer.classList.remove('hidden');
                photoSizeSelector.classList.remove('hidden');
                photoDetailsContainer.classList.add('hidden');
                subtitle.textContent = "Create a custom photographic frame.";
            } else if (type === 'resizer') {
                imageResizerContainer.classList.remove('hidden');
                resizeOptionsContainer.classList.add('hidden');
                subtitle.textContent = "Upload an image to resize or crop.";
            } else if (type === 'story') {
                storyGeneratorContainer.classList.remove('hidden');
                subtitle.textContent = "Create an illustrated story.";
            }
        }

        function showMainButtons() {
            currentFlow = 'main';
            chosenShape = null;
            chosenBGSize = null;
            chosenTextStyle = null;
            chosenTarotSize = null;
            uploadedPhotoData = null;
            chosenPhotoFrameSize = null;
            imageToResize = null;
            storyPages = [];
            resizeUploadInput.value = '';
            photoPreview.classList.add('hidden');
            photoUploadInput.value = '';
            frameThemeInput.value = '';
            frameTextInput.value = '';
            frameSubcategoriesContainer.classList.add('hidden');
            plaqueStyleSubcategoriesContainer.classList.add('hidden');
            plaqueShapeSubcategoriesContainer.classList.add('hidden');
            frameShapeSubcategoriesContainer.classList.add('hidden');
            backgroundGeneratorContainer.classList.add('hidden');
            textGeneratorContainer.classList.add('hidden');
            tarotGeneratorContainer.classList.add('hidden');
            deckGeneratorContainer.classList.add('hidden');
            photographicFrameContainer.classList.add('hidden');
            imageResizerContainer.classList.add('hidden');
            storyGeneratorContainer.classList.add('hidden');
            deckGalleryContainer.classList.add('hidden');
            storyGalleryContainer.classList.add('hidden');
            deckGallery.innerHTML = '';
            storyGallery.innerHTML = '';
            mainButtonsContainer.classList.remove('hidden');
            subtitle.textContent = "Click a button to instantly generate a unique, random decorative item.";
            // Reset aspect ratio when returning to main menu
            displayArea.classList.remove('aspect-[9/16]', 'aspect-[16/9]');
            displayArea.style.aspectRatio = '1 / 1';
            displayArea.classList.add('aspect-square');
        }
        
        generateFrameByStyleBtn.addEventListener('click', () => {
            currentFlow = 'styleFirst';
            showSubcategories('frame-style');
        });
        generateFrameByShapeBtn.addEventListener('click', () => {
            currentFlow = 'shapeFirst';
            showSubcategories('frame-shape');
        });
        generatePlaqueByStyleBtn.addEventListener('click', () => {
            displayArea.classList.remove('aspect-[9/16]', 'aspect-[16/9]');
            displayArea.classList.add('aspect-square');
            currentFlow = 'styleFirst';
            showSubcategories('plaque-style');
        });
        generatePlaqueByShapeBtn.addEventListener('click', () => {
            displayArea.classList.remove('aspect-[9/16]', 'aspect-[16/9]');
            displayArea.classList.add('aspect-square');
            currentFlow = 'shapeFirst';
            showSubcategories('plaque-shape');
        });
        generateBackgroundBtn.addEventListener('click', () => showSubcategories('background'));
        generateTextBtn.addEventListener('click', () => {
            displayArea.classList.remove('aspect-[9/16]', 'aspect-[16/9]');
            displayArea.classList.add('aspect-square');
            showSubcategories('text');
        });
        generateTarotCardBtn.addEventListener('click', () => {
            displayArea.classList.remove('aspect-square', 'aspect-[16/9]');
            displayArea.classList.add('aspect-[9/16]');
            showSubcategories('tarot');
        });
        generateDeckBtn.addEventListener('click', () => {
            displayArea.classList.remove('aspect-square', 'aspect-[16/9]');
            displayArea.classList.add('aspect-[9/16]');
            showSubcategories('deck');
        });
        generatePhotographicFrameBtn.addEventListener('click', () => {
             displayArea.classList.remove('aspect-[9/16]', 'aspect-[16/9]');
             displayArea.classList.add('aspect-square');
             showSubcategories('photographic-frame');
        });
        resizeImageBtn.addEventListener('click', () => showSubcategories('resizer'));
        generateStoryBtn.addEventListener('click', () => {
             displayArea.classList.remove('aspect-[9/16]', 'aspect-[16/9]');
             displayArea.classList.add('aspect-square');
             showSubcategories('story');
        });
        
        document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', showMainButtons));
        
        frameSubcategoriesContainer.querySelector('.back-btn').addEventListener('click', (e) => {
            e.stopPropagation(); 
            if (currentFlow === 'shapeFirst') showSubcategories('frame-shape');
            else showMainButtons();
        });

        plaqueStyleSubcategoriesContainer.querySelector('.back-btn').addEventListener('click', (e) => {
            e.stopPropagation(); 
            if (currentFlow === 'shapeFirst') showSubcategories('plaque-shape');
            else showMainButtons();
        });

        backgroundGeneratorContainer.querySelector('.back-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (!backgroundPromptContainer.classList.contains('hidden')) {
                backgroundPromptContainer.classList.add('hidden');
                backgroundSizeSelector.classList.remove('hidden');
                subtitle.textContent = "First, choose a size or type for your background.";
            } else {
                showMainButtons();
            }
        });

        tarotGeneratorContainer.querySelector('.back-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (!tarotPromptContainer.classList.contains('hidden')) {
                tarotPromptContainer.classList.add('hidden');
                tarotSizeSelector.classList.remove('hidden');
                subtitle.textContent = "First, choose a card size.";
            } else {
                showMainButtons();
            }
        });
        
        photographicFrameContainer.querySelector('.back-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (!photoDetailsContainer.classList.contains('hidden')) {
                photoDetailsContainer.classList.add('hidden');
                photoSizeSelector.classList.remove('hidden');
                subtitle.textContent = "Create a custom photographic frame.";
            } else {
                showMainButtons();
            }
        });

        // --- Password Protection Logic ---
        // You can change the password here
        const correctPassword = "generate";

        function checkPassword() {
            if (passwordInput.value === correctPassword) {
                passwordProtection.classList.add('hidden');
                mainContent.classList.remove('hidden');
            } else {
                passwordError.textContent = "Incorrect password. Please try again.";
                passwordInput.value = "";
            }
        }

        submitPasswordBtn.addEventListener('click', checkPassword);
        passwordInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                checkPassword();
            }
        });
        
     async function callGenerativeAPI(model, payload) {
    // This is the new, secure URL for your Netlify function
    const functionUrl = '/.netlify/functions/call-gemini'; 

    try {
        const response = await fetch(functionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // This sends the details to your secure function
            body: JSON.stringify({ model: model, payload: payload }) 
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Function error: ${response.status} ${errorText}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error("Could not fetch from Netlify function:", error);
        throw error;
    }
}

        // --- Image Generation ---
        async function generate(config) {
            lastGenerationConfig = config;

            // 1. Reset UI
            const allButtons = document.querySelectorAll('button, input');
            
            displayArea.classList.remove('aspect-square', 'aspect-[9/16]', 'aspect-[16/9]');
            resizeCanvas.classList.add('hidden');
            frameImage.classList.remove('hidden');
            storyDisplayContainer.classList.add('hidden');
            displayArea.style.aspectRatio = ''; // Reset dynamic aspect ratio

            if (config.type === 'photographic_frame') {
                 if (config.size === 'original' && uploadedPhotoData) {
                    const img = new Image();
                    img.onload = () => { displayArea.style.aspectRatio = img.width / img.height; };
                    img.src = uploadedPhotoData.dataUrl;
                } else if (config.size === '9:16') {
                    displayArea.classList.add('aspect-[9/16]');
                } else if (config.size === '16:9') {
                    displayArea.classList.add('aspect-[16/9]');
                } else { // 1:1
                    displayArea.classList.add('aspect-square');
                }
            }
            else if (config.subcategory === 'Exclusive Rectangle' || config.subcategory === 'Thin Border Horizontal') {
                 displayArea.classList.add('aspect-[16/9]');
            } else if (config.type === 'frame' || config.type === 'tarot' || config.type === 'deck_card' || config.size === '9:16' || config.size === 'tarot' || config.type === 'story_page') {
                displayArea.classList.add('aspect-[9/16]');
            } else {
                displayArea.classList.add('aspect-square');
            }
            
            allButtons.forEach(btn => btn.disabled = true);
            loader.classList.remove('hidden');
            frameImage.classList.add('hidden');
            initialText.classList.add('hidden');
            downloadBtn.classList.add('hidden');
            regenerateBtn.classList.add('hidden');
            resetBtn.classList.add('hidden');
            errorMessage.textContent = '';
            
            
            try {
                let imageUrl, textContent;
                if (config.type === 'story_page') {
                    const textPrompt = `Continue this story about '${config.storyTheme}'. The main character is '${config.characterDesc}'. The current scene is: '${config.pagePrompt}'. Write one or two paragraphs in a children's storybook style.`;
                    const imagePrompt = `An illustration for a children's book in the style of '${config.artStyle}'. The scene is: '${config.pagePrompt}'. The main character is: '${config.characterDesc}'. The character's appearance must be consistent across all images.`;

                    const imagePayload = {
                        contents: [{ parts: [{ text: imagePrompt }] }],
                        generationConfig: { responseModalities: ['IMAGE'] },
                    };
                    
                    const [textResult, imageResult] = await Promise.all([
                        callTextAPI(textPrompt),
                        callImageAPI(imagePayload)
                    ]);
                    
                    imageUrl = imageResult;
                    textContent = textResult;
                    
                    storyPages.push({ type: 'story', text: textContent, imageUrl: imageUrl, prompt: config.pagePrompt });
                    updateStoryUI(textContent, imageUrl);
                    addPageToStoryGallery();
                    downloadBtn.classList.add('hidden'); // Hide individual download for story pages
                    regenerateBtn.classList.remove('hidden');
                    resetBtn.classList.remove('hidden');
                    downloadPdfBtn.classList.remove('hidden');
                } else {
                    // 2. Create prompt & payload
                    let prompt = '';
                    let payload = {
                        contents: [{ parts: [] }],
                        generationConfig: { responseModalities: ['IMAGE'] },
                    };
                    
                    if (config.type === 'text') {
                         const styleDescription = textOptions[config.style];
                         prompt = `The text "${config.text}" ${styleDescription}. Ultra HD, 8K, high quality.`;
                         if (config.transparent) {
                             prompt += " Isolated with a fully transparent background, PNG format.";
                         } else {
                             prompt += " With a simple, complementary background that enhances the text.";
                         }
                         payload.contents[0].parts.push({ text: prompt });
                         downloadBtn.download = `text-${config.text.replace(/\s+/g, '_')}.png`;
                    } else if (config.type === 'background') {
                        let sizePrompt = '';
                        let isTransparentObject = false;

                        switch(config.size) {
                            case '16:9': sizePrompt = '**CRITICAL INSTRUCTION: The final image must have a 16:9 landscape aspect ratio.**'; break;
                            case '1:1': sizePrompt = '**CRITICAL INSTRUCTION: The final image must have a 1:1 square aspect ratio.**'; break;
                            case 'transparent':
                                sizePrompt = 'isolated with a fully transparent background, PNG format.';
                                isTransparentObject = true;
                                break;
                            case 'tarot':
                            case '9:16': 
                            default: 
                                sizePrompt = '**CRITICAL INSTRUCTION: Generate a TALL, VERTICAL image with a 9:16 aspect ratio. DO NOT CREATE a 1:1 square image.**'; 
                                break;
                        }

                        if (isTransparentObject) {
                            prompt = `A beautiful high-resolution image of ${config.prompt}, photorealistic, detailed, ultra HD, 8K, high quality, ${sizePrompt}`;
                        } else {
                            prompt = `A beautiful high-resolution photograph of ${config.prompt}, photorealistic, detailed, ultra HD, 8K, high quality. ${sizePrompt}`;
                        }
                         payload.contents[0].parts.push({ text: prompt });
                         downloadBtn.download = `background-${config.prompt.replace(/\s+/g, '_')}.png`;
                    } else if (config.type === 'tarot') {
                        const sizeInstruction = `The final image must be a tall, vertical tarot card shape, matching a standard ${config.size}.`;
                        let textInstruction = 'The card has no text, no numbers, and no borders.';
                        if (config.text && config.text.trim() !== '') {
                            textInstruction = `The card features the text "${config.text}" integrated into the design in a beautiful, stylized, thematic font.`;
                        }
                        let backgroundInstruction = 'The card has a beautiful, thematic background.';
                        if(config.transparent) {
                            backgroundInstruction = 'The card illustration is isolated on a fully transparent background, PNG format.';
                        }
                        prompt = `A beautiful, highly detailed illustration of a ${config.prompt} tarot card. Intricate artwork, vibrant colors, fantasy style. ${textInstruction} Ultra HD, 8K, high quality. ${sizeInstruction} ${backgroundInstruction} **CRITICAL INSTRUCTION: Generate a TALL, VERTICAL image with a tarot card aspect ratio. DO NOT CREATE a 1:1 square image.**`;
                        payload.contents[0].parts.push({ text: prompt });
                        downloadBtn.download = `tarot-${config.prompt.replace(/\s+/g, '_')}.png`;
                    } else if (config.type === 'deck_card') {
                        let textInstruction = 'No text, no numbers, and no borders on the card art.';
                        if (config.text && config.text.trim() !== '') {
                            textInstruction = `The card features the text "${config.text}" integrated into the design in a beautiful, stylized, thematic font that is consistent with the deck's style.`;
                        }
                        prompt = `A tarot card illustration of a '${config.cardName}' card. The card MUST be in the consistent artistic style of a tarot deck themed with '${config.theme}'. ${textInstruction} Ultra HD, 8K, high quality. **CRITICAL INSTRUCTION: Generate a TALL, VERTICAL image with a tarot card aspect ratio. DO NOT CREATE a 1:1 square image.**`;
                        payload.contents[0].parts.push({ text: prompt });
                        downloadBtn.download = `deck-${config.theme.replace(/\s+/g, '_')}-${config.cardName.replace(/\s+/g, '_')}.png`;
                    } else if (config.type === 'photographic_frame') {
                         let sizePrompt = '';
                        switch(config.size) {
                            case '16:9': sizePrompt = '**CRITICAL INSTRUCTION: The final output image must have a 16:9 landscape aspect ratio.**'; break;
                            case '9:16': sizePrompt = '**CRITICAL INSTRUCTION: The final output image must have a 9:16 portrait aspect ratio.**'; break;
                            case '1:1': sizePrompt = '**CRITICAL INSTRUCTION: The final output image must have a 1:1 square aspect ratio.**'; break;
                            case 'original':
                            default: sizePrompt = 'The final output image should maintain the original aspect ratio of the uploaded photo.'; break;
                        }

                         prompt = `Create a beautiful photographic frame around the provided image. The theme of the frame is "${config.theme}".`;
                         if(config.text && config.text.trim() !== '') {
                            prompt += ` Add the text "${config.text}" onto the image in a fun, celebratory font that matches the theme.`
                         }
                         prompt += ` The final output should be a complete image including the original photo, the new frame, and the text. Ultra HD, 8K, high quality. ${sizePrompt}`;

                         payload.contents[0].parts.push({ text: prompt });
                         payload.contents[0].parts.push({ 
                            inlineData: {
                                mimeType: config.imageData.mimeType,
                                data: config.imageData.dataUrl.split(',')[1]
                            }
                         });
                         downloadBtn.download = `framed-photo-${config.theme.replace(/\s+/g, '_')}.png`;
                    }
                    else {
                        let randomStyle, useShape, randomDetail;
                        const itemType = (config.type === 'frame') ? "picture frame" : "plaque";

                        if (config.subcategory) { // Style-based generation
                            const options = (config.type === 'frame') ? frameOptions[config.subcategory] : plaqueOptions[config.subcategory];
                            randomStyle = options.styles[Math.floor(Math.random() * options.styles.length)];
                            useShape = config.shape || options.shapes[Math.floor(Math.random() * options.shapes.length)];
                            randomDetail = options.details[Math.floor(Math.random() * options.details.length)];
                            downloadBtn.download = `generated-${config.type}-${config.subcategory}-${useShape}.png`;
                        }

                        const basePrompt = `A highly detailed, ${randomStyle} ${useShape} ${itemType}, ${randomDetail}. The center of the ${itemType} MUST be a solid, opaque surface (like wood, gold, acrylic, etc.), suitable for adding text or a picture later. The center must NOT be transparent. No photo, no image, no text, no content inside. Studio lighting, photorealistic, ultra HD, 8K, high quality.`;

                        if (config.subcategory === 'Exclusive Rectangle' || config.subcategory === 'Thin Border Horizontal') {
                            prompt = `**CRITICAL INSTRUCTION: Generate a WIDE, HORIZONTAL image with a 16:9 aspect ratio.** The subject is: ${basePrompt} The entire image must be in a 16:9 landscape format. Isolated with a fully transparent background, PNG format. **DO NOT CREATE a square or vertical image.**`;
                        } else if (config.type === 'frame') {
                            prompt = `**CRITICAL INSTRUCTION: Generate a TALL, VERTICAL image with a 9:16 aspect ratio.** The subject is: ${basePrompt} The entire image must be in a 9:16 portrait format. Isolated with a fully transparent background, PNG format. **DO NOT CREATE a 1:1 square image.**`;
                        } else {
                            prompt = `${basePrompt} Isolated with a fully transparent background, PNG format.`;
                        }
                         payload.contents[0].parts.push({ text: prompt });
                    }

                    imageUrl = await callImageAPI(payload);
                    frameImage.src = imageUrl;
                    frameImage.classList.remove('hidden');
                    downloadBtn.href = imageUrl;
                    downloadBtn.classList.remove('hidden');
                    regenerateBtn.classList.remove('hidden');
                    resetBtn.classList.remove('hidden');

                    if (config.type === 'deck_card') {
                        addCardToGallery(imageUrl, config.cardName);
                    }
                }
            } catch (error) {
                console.error("Error generating:", error);
                errorMessage.textContent = "Failed to generate. Please try again.";
                initialText.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                allButtons.forEach(btn => btn.disabled = false);
                 // After a text generation or photo frame generation, re-check state to disable buttons
                if(config.type === 'text') checkTextGeneratorState();
                if(config.type === 'photographic_frame') checkPhotoFrameState();
            }
        }
        
        function updateStoryUI(text, imageUrl) {
            storyDisplayContainer.classList.remove('hidden');
            storyImageDisplay.src = imageUrl;
            storyTextDisplay.textContent = text;
        }

        function addPageToStoryGallery() {
            storyGalleryContainer.classList.remove('hidden');
            storyGallery.innerHTML = ''; // Clear and rebuild
            storyPages.forEach((page, index) => {
                const thumbContainer = document.createElement('div');
                thumbContainer.className = 'relative group w-24 text-center';

                const thumbImg = document.createElement('img');
                thumbImg.src = page.imageUrl;
                thumbImg.className = 'h-24 w-auto rounded-md border-2 border-white shadow-md mx-auto';
                
                const thumbText = document.createElement('p');
                thumbText.textContent = `Page ${index + 1}`;
                thumbText.className = 'text-xs mt-1 text-gray-600 truncate';

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.className = 'absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center font-bold opacity-0 group-hover:opacity-100 transition-opacity';
                deleteBtn.onclick = () => {
                    storyPages.splice(index, 1);
                    addPageToStoryGallery(); // Re-render the gallery
                };

                thumbContainer.appendChild(deleteBtn);
                thumbContainer.appendChild(thumbImg);
                thumbContainer.appendChild(thumbText);
                storyGallery.appendChild(thumbContainer);
            });
        }
        
        function addCardToGallery(imageUrl, cardName) {
            deckGalleryContainer.classList.remove('hidden');
            const thumbContainer = document.createElement('div');
            thumbContainer.className = 'relative group';

            const thumbImg = document.createElement('img');
            thumbImg.src = imageUrl;
            thumbImg.className = 'h-24 w-auto rounded-md border-2 border-white shadow-md';
            
            const thumbDownload = document.createElement('a');
            thumbDownload.href = imageUrl;
            thumbDownload.download = `deck-${deckThemeInput.value.trim().replace(/\s+/g, '_')}-${cardName.replace(/\s+/g, '_')}.png`;
            thumbDownload.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
            `;
            thumbDownload.className = 'absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-2 bg-black/50 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity';
            
            thumbContainer.appendChild(thumbImg);
            thumbContainer.appendChild(thumbDownload);
            deckGallery.appendChild(thumbContainer);
        }

        plaqueStyleSubcategoriesContainer.querySelectorAll('.subcategory-btn[data-subcategory]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const { type, subcategory } = e.target.dataset;
                const config = { type, subcategory, shape: chosenShape }; 
                generate(config);
            });
        });

        frameSubcategoriesContainer.querySelectorAll('.subcategory-btn[data-subcategory]').forEach(btn => {
             btn.addEventListener('click', (e) => {
                const { type, subcategory } = e.target.dataset;
                const config = { type, subcategory, shape: chosenShape };
                // Immediately set aspect ratio for frames
                displayArea.classList.remove('aspect-square', 'aspect-[16/9]');
                displayArea.classList.add('aspect-[9/16]');
                generate(config);
            });
        });

        plaqueShapeSubcategoriesContainer.querySelectorAll('.subcategory-btn[data-shape]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                chosenShape = e.target.dataset.shape;
                showSubcategories('plaque-style');
            });
        });

        frameShapeSubcategoriesContainer.querySelectorAll('.subcategory-btn[data-shape]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                chosenShape = e.target.dataset.shape;
                 // Immediately set aspect ratio for frames
                displayArea.classList.remove('aspect-square', 'aspect-[16/9]');
                displayArea.classList.add('aspect-[9/16]');
                showSubcategories('frame-style');
            });
        });

        backgroundSizeSelector.querySelectorAll('.subcategory-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                chosenBGSize = e.target.dataset.size;
                 // Adjust display area aspect ratio immediately upon selection
                displayArea.classList.remove('aspect-square', 'aspect-[9/16]', 'aspect-[16/9]');
                if (chosenBGSize === '9:16' || chosenBGSize === 'tarot') {
                    displayArea.classList.add('aspect-[9/16]');
                } else if (chosenBGSize === '16:9') {
                    displayArea.classList.add('aspect-[16/9]');
                }
                 else {
                    displayArea.classList.add('aspect-square');
                }

                if (chosenBGSize === 'tarot') {
                    backgroundInput.value = 'angel chibi card';
                } else {
                    backgroundInput.value = '';
                }

                backgroundSizeSelector.classList.add('hidden');
                backgroundPromptContainer.classList.remove('hidden');
                subtitle.textContent = `Describe the item or background (${chosenBGSize.replace(':', 'x')}):`;
                backgroundInput.focus();
            });
        });

        submitBackgroundBtn.addEventListener('click', () => {
            const userInput = backgroundInput.value.trim();
            if (userInput && chosenBGSize) {
                generate({ type: 'background', prompt: userInput, size: chosenBGSize });
            } else if (!userInput) {
                errorMessage.textContent = "Please enter a description for the background.";
            }
        });

        regenerateBtn.addEventListener('click', () => {
            if (lastGenerationConfig) {
                generate(lastGenerationConfig);
            }
        });
        
        resetBtn.addEventListener('click', () => {
            frameImage.classList.add('hidden');
            storyDisplayContainer.classList.add('hidden');
            frameImage.src = '';
            downloadBtn.classList.add('hidden');
            regenerateBtn.classList.add('hidden');
            resetBtn.classList.add('hidden');
            initialText.classList.remove('hidden');
            errorMessage.textContent = '';
            lastGenerationConfig = null;
            showMainButtons();
        });
        
        // --- Text Generator Logic ---
        function checkTextGeneratorState() {
            const hasText = textInput.value.trim() !== '';
            const hasStyle = chosenTextStyle !== null;
            const canGenerate = hasText && hasStyle;
            submitTextTransparentBtn.disabled = !canGenerate;
            submitTextWithBgBtn.disabled = !canGenerate;
        }

        textInput.addEventListener('input', checkTextGeneratorState);

        textStyleButtonsContainer.querySelectorAll('.subcategory-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Remove active class from all buttons in this container
                textStyleButtonsContainer.querySelectorAll('.subcategory-btn').forEach(b => b.classList.remove('subcategory-btn-active'));
                // Add active class to the clicked button
                e.target.classList.add('subcategory-btn-active');
                chosenTextStyle = e.target.dataset.style;
                checkTextGeneratorState();
            });
        });
        
        submitTextTransparentBtn.addEventListener('click', () => {
            generate({
                type: 'text',
                text: textInput.value.trim(),
                style: chosenTextStyle,
                transparent: true
            });
        });
        
        submitTextWithBgBtn.addEventListener('click', () => {
            generate({
                type: 'text',
                text: textInput.value.trim(),
                style: chosenTextStyle,
                transparent: false
            });
        });

        // --- Tarot Card Logic ---
        tarotSizeSelector.querySelectorAll('.subcategory-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                chosenTarotSize = e.target.dataset.size;
                tarotSizeSelector.classList.add('hidden');
                tarotPromptContainer.classList.remove('hidden');
                subtitle.textContent = `Choose a theme for your ${chosenTarotSize}:`;
                tarotInput.focus();
            });
        });

        tarotThemeButtons.querySelectorAll('.subcategory-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                tarotInput.value = e.target.dataset.theme;
            });
        });

        submitTarotTransparentBtn.addEventListener('click', () => {
            const userInput = tarotInput.value.trim();
            const textInputVal = tarotTextInput.value.trim();
            if (userInput && chosenTarotSize) {
                generate({ type: 'tarot', prompt: userInput, size: chosenTarotSize, text: textInputVal, transparent: true });
            } else if (!userInput) {
                errorMessage.textContent = "Please enter a description for the tarot card.";
            }
        });
        
        submitTarotWithBgBtn.addEventListener('click', () => {
            const userInput = tarotInput.value.trim();
            const textInputVal = tarotTextInput.value.trim();
            if (userInput && chosenTarotSize) {
                generate({ type: 'tarot', prompt: userInput, size: chosenTarotSize, text: textInputVal, transparent: false });
            } else if (!userInput) {
                errorMessage.textContent = "Please enter a description for the tarot card.";
            }
        });

        // --- Deck Generator Logic ---
        submitDeckCardBtn.addEventListener('click', () => {
            const theme = deckThemeInput.value.trim();
            const cardName = cardNameInput.value.trim();
            const cardText = deckCardTextInput.value.trim();
            if (theme && cardName) {
                generate({ type: 'deck_card', theme, cardName, text: cardText });
            } else {
                errorMessage.textContent = "Please provide both a deck theme and a card name.";
            }
        });

        // --- Photographic Frame Logic ---
        function checkPhotoFrameState() {
            const hasPhoto = uploadedPhotoData !== null;
            const hasTheme = frameThemeInput.value.trim() !== '';
            const hasSize = chosenPhotoFrameSize !== null;
            submitPhotographicFrameBtn.disabled = !(hasPhoto && hasTheme && hasSize);
        }

        photoSizeSelector.querySelectorAll('.subcategory-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                chosenPhotoFrameSize = e.target.dataset.photosize;
                photoSizeSelector.classList.add('hidden');
                photoDetailsContainer.classList.remove('hidden');
                subtitle.textContent = `Upload your photo and describe the frame:`;

                // Immediately set aspect ratio for the display area
                displayArea.classList.remove('aspect-square', 'aspect-[9/16]', 'aspect-[16/9]');
                displayArea.style.aspectRatio = '';
                if (chosenPhotoFrameSize === '9:16') {
                    displayArea.classList.add('aspect-[9/16]');
                } else if (chosenPhotoFrameSize === '16:9') {
                    displayArea.classList.add('aspect-[16/9]');
                } else { // 1:1 and original (will be updated on upload for original)
                    displayArea.classList.add('aspect-square');
                }
            });
        });

        photoUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedPhotoData = {
                        dataUrl: event.target.result,
                        mimeType: file.type
                    };
                    photoPreview.src = event.target.result;
                    photoPreview.classList.remove('hidden');
                    checkPhotoFrameState();
                    
                    if (chosenPhotoFrameSize === 'original') {
                        const img = new Image();
                        img.onload = () => {
                            displayArea.classList.remove('aspect-square', 'aspect-[9/16]', 'aspect-[16/9]');
                            displayArea.style.aspectRatio = img.width / img.height;
                        };
                        img.src = event.target.result;
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        frameThemeInput.addEventListener('input', checkPhotoFrameState);

        submitPhotographicFrameBtn.addEventListener('click', () => {
            generate({
                type: 'photographic_frame',
                theme: frameThemeInput.value.trim(),
                text: frameTextInput.value.trim(),
                imageData: uploadedPhotoData,
                size: chosenPhotoFrameSize
            });
        });

        // --- Image Resizer Logic ---
        resizeUploadInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imageToResize = new Image();
                    imageToResize.onload = () => {
                        // Display the original image in the display area
                        initialText.classList.add('hidden');
                        frameImage.src = event.target.result;
                        frameImage.classList.remove('hidden');
                        resizeCanvas.classList.add('hidden');
                        displayArea.classList.remove('aspect-square', 'aspect-[9/16]', 'aspect-[16/9]');
                        displayArea.style.aspectRatio = imageToResize.width / imageToResize.height;
                        resizeOptionsContainer.classList.remove('hidden');
                        subtitle.textContent = "Now, choose a size to crop to.";
                    };
                    imageToResize.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        function cropImage(targetRatio) {
            const [targetW, targetH] = targetRatio.split(':').map(Number);
            const sourceW = imageToResize.width;
            const sourceH = imageToResize.height;
            const sourceRatio = sourceW / sourceH;
            const finalRatio = targetW / targetH;

            let finalW = sourceW;
            let finalH = sourceH;
            let sx = 0;
            let sy = 0;

            if (sourceRatio > finalRatio) { // source is wider than target
                finalW = sourceH * finalRatio;
                sx = (sourceW - finalW) / 2;
            } else { // source is taller than target
                finalH = sourceW / finalRatio;
                sy = (sourceH - finalH) / 2;
            }
            
            resizeCanvas.width = finalW;
            resizeCanvas.height = finalH;
            
            const ctx = resizeCanvas.getContext('2d');
            ctx.drawImage(imageToResize, sx, sy, finalW, finalH, 0, 0, finalW, finalH);
            
            // Display the cropped image
            frameImage.classList.add('hidden');
            resizeCanvas.classList.remove('hidden');
            displayArea.classList.remove('aspect-square', 'aspect-[9/16]', 'aspect-[16/9]');
            displayArea.style.aspectRatio = `${finalW} / ${finalH}`;

            // Update download button
            downloadBtn.href = resizeCanvas.toDataURL('image/png');
            downloadBtn.download = `resized-image-${targetW}x${targetH}.png`;
            downloadBtn.classList.remove('hidden');
            resetBtn.classList.remove('hidden');
            regenerateBtn.classList.add('hidden');
        }

        resizeOptionsContainer.querySelectorAll('.subcategory-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (imageToResize) {
                    cropImage(e.target.dataset.resize);
                }
            });
        });

        // --- Story Generator Logic ---
        
        async function generateFullStory(pageCount) {
             const storyTheme = storyThemeInput.value.trim();
             const artStyle = artStyleInput.value.trim();
             const characterDesc = characterDescInput.value.trim();

            if (!storyTheme || !artStyle || !characterDesc) {
                 errorMessage.textContent = "Please fill in all story, character, and style fields first.";
                 return;
            }
            
            // Generate Outline
             subtitle.textContent = "Generating story outline...";
             const outlinePrompt = `Generate a simple ${pageCount}-point plot outline for a children's story about '${storyTheme}' featuring a character described as '${characterDesc}'. Each point should be a single, simple sentence describing a scene. Format as a numbered list.`;
             const outlineResult = await callTextAPI(outlinePrompt);
             const outlinePoints = outlineResult.split('\n').filter(line => line.match(/^\d+\./)).map(line => line.replace(/^\d+\.\s*/, ''));
            
            storyPages = []; // Clear existing pages
            
            for(let i=0; i < outlinePoints.length; i++) {
                subtitle.textContent = `Generating page ${i+1} of ${pageCount}...`;
                const pagePrompt = outlinePoints[i];
                await generate({ type: 'story_page', storyTheme, artStyle, pagePrompt, characterDesc });
            }
            
             subtitle.textContent = "Story generation complete!";
        }

        gen1PageBtn.addEventListener('click', () => generateFullStory(1));
        gen10PageBtn.addEventListener('click', () => generateFullStory(10));
        gen25PageBtn.addEventListener('click', () => generateFullStory(25));
        gen50PageBtn.addEventListener('click', () => generateFullStory(50));
        gen100PageBtn.addEventListener('click', () => generateFullStory(100));


        addCustomPageBtn.addEventListener('click', async () => {
             const storyTheme = storyThemeInput.value.trim();
             const artStyle = artStyleInput.value.trim();
             const characterDesc = characterDescInput.value.trim();
             const customText = customPageTextInput.value.trim();
             const customImagePrompt = customPageImagePrompt.value.trim();

            if (!storyTheme || !artStyle || !characterDesc || !customText || !customImagePrompt) {
                 errorMessage.textContent = "Please fill in all story fields and the custom page fields.";
                 return;
            }
            subtitle.textContent = "Generating custom page...";
            const imagePrompt = `An illustration in the style of '${artStyle}' for a story about '${storyTheme}'. The scene is: '${customImagePrompt}'. The main character is: '${characterDesc}'.`;
            const imagePayload = { contents: [{ parts: [{ text: imagePrompt }] }] };

            try {
                const imageUrl = await callImageAPI(imagePayload);
                storyPages.push({ type: 'story', text: customText, imageUrl: imageUrl, prompt: customImagePrompt });
                updateStoryUI(customText, imageUrl);
                addPageToStoryGallery();
                downloadPdfBtn.classList.remove('hidden');
                customPageTextInput.value = '';
                customPageImagePrompt.value = '';
            } catch(e) {
                errorMessage.textContent = "Failed to generate custom page image.";
            } finally {
                subtitle.textContent = "Create an illustrated story.";
            }
        });


        downloadPdfBtn.addEventListener('click', async () => {
            const { jsPDF } = window.jspdf;
            const bookSize = bookSizeSelect.value;
            let format;
            
            switch(bookSize) {
                case 'kindle':
                case 'paperback':
                    format = [6 * 72, 9 * 72]; // 6x9 inches in points
                    break;
                case 'hardcover':
                    format = [6.14 * 72, 9.21 * 72]; // 6.14x9.21 inches in points
                    break;
                case 'picturebook':
                    format = [8.5 * 72, 8.5 * 72]; // 8.5x8.5 inches in points
                    break;
                case 'google':
                default:
                    format = 'a4';
                    break;
            }

            const doc = new jsPDF({
                orientation: 'p',
                unit: 'pt',
                format: format
            });
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 40;
            const contentWidth = pageWidth - (margin * 2);

            // --- Front Cover ---
            subtitle.textContent = 'Generating Front Cover...';
            const coverPrompt = `A beautiful and captivating book cover for a story titled '${storyTitleInput.value.trim()}' about '${storyThemeInput.value.trim()}'. Art style is '${artStyleInput.value.trim()}'. The cover should be mostly illustrative with the title prominently featured.`;
            const coverPayload = { contents: [{ parts: [{ text: coverPrompt }] }] };
            const coverImageUrl = await callImageAPI(coverPayload);
            const coverImg = new Image();
            coverImg.src = coverImageUrl;
            await new Promise(r => coverImg.onload = r);
            doc.addImage(coverImg, 'PNG', 0, 0, pageWidth, pageHeight);

            // --- Title Page ---
            doc.addPage();
            doc.setFontSize(24);
            doc.text(storyTitleInput.value.trim(), pageWidth / 2, pageHeight * 0.4, { align: 'center' });
            doc.setFontSize(16);
            doc.text(`by ${authorNameInput.value.trim()}`, pageWidth / 2, pageHeight * 0.5, { align: 'center' });
            
            for (let i = 0; i < storyPages.length; i++) {
                const page = storyPages[i];
                subtitle.textContent = `Formatting page ${i+1} of ${storyPages.length}...`;
                
                // Page for Text (Left page of spread)
                doc.addPage();
                doc.setFontSize(12);
                const textLines = doc.splitTextToSize(page.text, contentWidth);
                doc.text(textLines, margin, margin);

                // Page for Image (Right page of spread)
                doc.addPage();
                const img = new Image();
                img.src = page.imageUrl;
                
                await new Promise(resolve => {
                    img.onload = () => {
                        const imgWidth = img.width;
                        const imgHeight = img.height;
                        const ratio = imgWidth / imgHeight;

                        let newWidth = contentWidth;
                        let newHeight = newWidth / ratio;
                        
                        // Center image on the page
                        const x = (pageWidth - newWidth) / 2;
                        const y = (pageHeight - newHeight) / 2;

                        doc.addImage(img, 'PNG', x, y, newWidth, newHeight);
                        resolve();
                    };
                    img.onerror = () => {
                        console.error("Failed to load image for PDF");
                        resolve(); 
                    }
                });
            }

            // --- Back Cover ---
             subtitle.textContent = 'Generating Back Cover...';
             const blurb = authorBlurbInput.value.trim();
             const backCoverPrompt = `A simple back cover for a book in the art style of '${artStyleInput.value.trim()}'. It should have a clean design with space in the middle for text.`;
             const backCoverPayload = { contents: [{ parts: [{ text: backCoverPrompt }] }] };
             const backCoverImgUrl = await callImageAPI(backCoverPayload);
             const backCoverImg = new Image();
             backCoverImg.src = backCoverImgUrl;
             await new Promise(r => backCoverImg.onload = r);
             doc.addPage();
             doc.addImage(backCoverImg, 'PNG', 0, 0, pageWidth, pageHeight);
             if (blurb) {
                 doc.setFontSize(10);
                 const blurbLines = doc.splitTextToSize(blurb, contentWidth * 0.8);
                 doc.text(blurbLines, pageWidth / 2, pageHeight / 2, { align: 'center' });
             }

            const storyTitle = storyTitleInput.value.trim().replace(/\s+/g, '_') || 'my-story';
            doc.save(`${storyTitle}.pdf`);
            subtitle.textContent = "Create an illustrated story.";
        });

    </script>
    <script>
        // This script disables right-clicking and common keyboard shortcuts
        // to make it harder for casual users to copy the source code.
        // Note: This is not a foolproof security measure, but a deterrent.

        // Disable right-click context menu
        document.addEventListener('contextmenu', event => event.preventDefault());

        // Disable specific keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Disable F12 (Developer Tools)
            if (event.key === 'F12' || event.keyCode === 123) {
                event.preventDefault();
            }

            // Disable Ctrl+S (Save)
            if (event.ctrlKey && (event.key === 's' || event.key === 'S')) {
                event.preventDefault();
            }

            // Disable Ctrl+U (View Source)
            if (event.ctrlKey && (event.key === 'u' || event.key === 'U')) {
                event.preventDefault();
            }
            
            // Disable Ctrl+C (Copy)
            if (event.ctrlKey && (event.key === 'c' || event.key === 'C')) {
                event.preventDefault();
            }
        });
    </script>
</body>
</html>

